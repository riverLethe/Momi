# 账单同步策略详细设计

## 概述

本文档详细描述了 Momi 应用的账单同步策略，包括用户登录时的一次性同步选择和常规的定时同步机制。

## 1. 用户登录后的一次性同步选择

### 1.1 Clear & Download Remote（清空并下载）

**功能描述**：清空本地所有个人账单，从远程服务器下载用户的完整账单数据。

**执行流程**：

1. 清空本地存储的所有账单数据
2. 从远程服务器分批下载用户的所有账单
3. 保存到本地存储
4. 自动更新所有统计信息（月度支出、分类统计、预算使用情况等）
5. 刷新UI显示

**适用场景**：

- 新设备首次登录
- 本地数据损坏或不一致
- 用户希望以远程数据为准

### 1.2 Push & Override Remote（推送并覆盖）

**功能描述**：将本地的所有个人账单推送到远程服务器，覆盖远程的账单数据。

**执行流程**：

1. 收集本地所有账单数据
2. 分批上传到远程服务器
3. 远程服务器软删除原有数据
4. 插入新的本地数据
5. 更新同步时间戳

**适用场景**：

- 本地数据是最新最准确的
- 远程数据有问题需要重置
- 从其他设备迁移数据

### 1.3 Merge（智能合并）

**功能描述**：将远程和本地的账单数据智能合并，避免重复，保留最新版本。

**执行流程**：

1. 获取本地账单数据
2. 获取远程账单数据（基于上次同步时间）
3. 根据账单ID进行智能合并：
   - 相同ID：比较更新时间，保留最新版本
   - 新增账单：直接添加
   - 删除账单：标记为已删除
4. 检测并处理冲突
5. 更新本地数据
6. 自动更新统计信息

**适用场景**：

- 多设备使用的常规同步
- 本地和远程都有更新
- 希望保留所有数据的合并

## 2. 常规定时同步策略

### 2.1 离线操作记录机制

**功能描述**：在用户断网状态下，记录所有对账单的操作，形成操作队列。

**操作类型**：

- `CREATE`：新增账单
- `UPDATE`：修改账单
- `DELETE`：删除账单

### 2.2 自动后台同步机制

**功能描述**：当用户有网络连接时，自动检测并同步离线操作记录。

**执行流程**：

1. 检测网络状态
2. 检查是否有离线操作记录
3. 如果有记录，启动后台同步：
   - 分批处理操作记录（每批最多50个操作）
   - 按时间顺序执行操作
   - 处理服务器响应和冲突
   - 更新本地数据
   - 清除已同步的操作记录
4. 更新同步状态和时间戳

**触发条件**：

- 网络从断开恢复到连接
- 应用从后台切换到前台
- 用户手动触发同步
- 定时检查（每5分钟）

### 2.3 登出时清理机制

**功能描述**：用户退出登录时，清空所有离线操作记录。

**执行流程**：

1. 检测用户登出事件
2. 清空 `offline_operations_queue`
3. 清空同步状态缓存
4. 重置同步时间戳

## 3. 数据量过大的解决方案

### 3.1 分片传输机制

**实现方式**：

- **分页下载**：每次最多下载1000条账单记录
- **分批上传**：每次最多上传500条账单记录
- **断点续传**：支持传输中断后从断点继续

### 3.2 数据压缩

**实现方式**：

- 使用 gzip 压缩传输数据
- 客户端和服务端都支持压缩/解压
- 减少网络传输时间和流量

### 3.3 增量同步优化

**实现方式**：

- 基于 `lastSyncTime` 只同步变更数据
- 使用 `sync_version` 字段进行冲突检测
- 支持软删除，避免数据丢失

### 3.4 用户登录后的一次性同步选择的进度反馈

**实现方式**：

- 显示同步进度条
- 实时更新同步状态
- 支持取消长时间同步操作

## 4. 错误处理和重试机制

### 4.1 网络错误处理

- 自动重试（最多3次）
- 指数退避策略
- 用户友好的错误提示

### 4.2 数据冲突处理

- 自动解决简单冲突
- 复杂冲突提示用户选择
- 保留冲突记录供后续处理

### 4.3 数据完整性检查

- 同步前后数据校验
- 关键字段完整性检查
- 异常数据自动修复

## 5. 性能优化

### 5.1 缓存策略

- 本地数据缓存
- 同步状态缓存
- 减少重复网络请求

### 5.2 后台同步

- 利用后台任务进行同步
- 不阻塞用户界面
- 智能调度同步时机
